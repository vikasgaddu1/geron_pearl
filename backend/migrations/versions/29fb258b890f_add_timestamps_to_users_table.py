"""Add timestamps to users table

Revision ID: 29fb258b890f
Revises: add_ich_category
Create Date: 2025-12-22 19:03:44.681393

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '29fb258b890f'
down_revision = 'add_ich_category'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint('audit_log_user_id_fkey', 'audit_log', type_='foreignkey')
    op.create_foreign_key(None, 'audit_log', 'users', ['user_id'], ['id'])
    op.drop_constraint('database_releases_study_id_fkey', 'database_releases', type_='foreignkey')
    op.create_foreign_key(None, 'database_releases', 'studies', ['study_id'], ['id'])
    op.drop_constraint('package_dataset_details_package_item_id_fkey', 'package_dataset_details', type_='foreignkey')
    op.create_foreign_key(None, 'package_dataset_details', 'package_items', ['package_item_id'], ['id'])
    op.drop_constraint('package_item_acronyms_package_item_id_fkey', 'package_item_acronyms', type_='foreignkey')
    op.drop_constraint('package_item_acronyms_acronym_id_fkey', 'package_item_acronyms', type_='foreignkey')
    op.create_foreign_key(None, 'package_item_acronyms', 'package_items', ['package_item_id'], ['id'])
    op.create_foreign_key(None, 'package_item_acronyms', 'text_elements', ['acronym_id'], ['id'])
    op.drop_constraint('package_item_footnotes_package_item_id_fkey', 'package_item_footnotes', type_='foreignkey')
    op.drop_constraint('package_item_footnotes_footnote_id_fkey', 'package_item_footnotes', type_='foreignkey')
    op.create_foreign_key(None, 'package_item_footnotes', 'text_elements', ['footnote_id'], ['id'])
    op.create_foreign_key(None, 'package_item_footnotes', 'package_items', ['package_item_id'], ['id'])
    op.drop_constraint('package_items_package_id_fkey', 'package_items', type_='foreignkey')
    op.create_foreign_key(None, 'package_items', 'packages', ['package_id'], ['id'])
    op.drop_constraint('package_tlf_details_package_item_id_fkey', 'package_tlf_details', type_='foreignkey')
    op.drop_constraint('package_tlf_details_ich_category_id_fkey', 'package_tlf_details', type_='foreignkey')
    op.drop_constraint('package_tlf_details_title_id_fkey', 'package_tlf_details', type_='foreignkey')
    op.drop_constraint('package_tlf_details_population_flag_id_fkey', 'package_tlf_details', type_='foreignkey')
    op.create_foreign_key(None, 'package_tlf_details', 'text_elements', ['title_id'], ['id'])
    op.create_foreign_key(None, 'package_tlf_details', 'text_elements', ['population_flag_id'], ['id'])
    op.create_foreign_key(None, 'package_tlf_details', 'package_items', ['package_item_id'], ['id'])
    op.create_foreign_key(None, 'package_tlf_details', 'text_elements', ['ich_category_id'], ['id'])
    op.drop_constraint('reporting_effort_dataset_details_reporting_effort_item_id_fkey', 'reporting_effort_dataset_details', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_dataset_details', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'])
    op.drop_constraint('reporting_effort_item_acronyms_reporting_effort_item_id_fkey', 'reporting_effort_item_acronyms', type_='foreignkey')
    op.drop_constraint('reporting_effort_item_acronyms_acronym_id_fkey', 'reporting_effort_item_acronyms', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_item_acronyms', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_item_acronyms', 'text_elements', ['acronym_id'], ['id'])
    op.drop_constraint('reporting_effort_item_footnotes_footnote_id_fkey', 'reporting_effort_item_footnotes', type_='foreignkey')
    op.drop_constraint('reporting_effort_item_footnotes_reporting_effort_item_id_fkey', 'reporting_effort_item_footnotes', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_item_footnotes', 'text_elements', ['footnote_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_item_footnotes', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'])
    op.drop_constraint('reporting_effort_item_tracker_qc_programmer_id_fkey', 'reporting_effort_item_tracker', type_='foreignkey')
    op.drop_constraint('reporting_effort_item_tracker_production_programmer_id_fkey', 'reporting_effort_item_tracker', type_='foreignkey')
    op.drop_constraint('reporting_effort_item_tracker_reporting_effort_item_id_fkey', 'reporting_effort_item_tracker', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_item_tracker', 'users', ['qc_programmer_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_item_tracker', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_item_tracker', 'users', ['production_programmer_id'], ['id'])
    op.drop_constraint('reporting_effort_items_reporting_effort_id_fkey', 'reporting_effort_items', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_items', 'reporting_efforts', ['reporting_effort_id'], ['id'])
    op.drop_constraint('reporting_effort_tlf_details_title_id_fkey', 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint('reporting_effort_tlf_details_population_flag_id_fkey', 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint('reporting_effort_tlf_details_ich_category_id_fkey', 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint('reporting_effort_tlf_details_reporting_effort_item_id_fkey', 'reporting_effort_tlf_details', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_effort_tlf_details', 'text_elements', ['title_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_tlf_details', 'text_elements', ['ich_category_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_tlf_details', 'text_elements', ['population_flag_id'], ['id'])
    op.create_foreign_key(None, 'reporting_effort_tlf_details', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'])
    op.drop_constraint('reporting_efforts_database_release_id_fkey', 'reporting_efforts', type_='foreignkey')
    op.drop_constraint('reporting_efforts_study_id_fkey', 'reporting_efforts', type_='foreignkey')
    op.create_foreign_key(None, 'reporting_efforts', 'database_releases', ['database_release_id'], ['id'])
    op.create_foreign_key(None, 'reporting_efforts', 'studies', ['study_id'], ['id'])
    op.drop_constraint('uq_studies_study_label', 'studies', type_='unique')
    op.drop_index('ix_studies_study_label', table_name='studies')
    op.create_index(op.f('ix_studies_study_label'), 'studies', ['study_label'], unique=True)
    op.create_index(op.f('ix_tracker_comments_created_at'), 'tracker_comments', ['created_at'], unique=False)
    op.create_index(op.f('ix_tracker_comments_is_resolved'), 'tracker_comments', ['is_resolved'], unique=False)
    op.drop_constraint('tracker_comments_resolved_by_user_id_fkey', 'tracker_comments', type_='foreignkey')
    op.drop_constraint('tracker_comments_user_id_fkey', 'tracker_comments', type_='foreignkey')
    op.create_foreign_key(None, 'tracker_comments', 'users', ['resolved_by_user_id'], ['id'])
    op.create_foreign_key(None, 'tracker_comments', 'users', ['user_id'], ['id'])
    # Add columns as nullable first
    op.add_column('users', sa.Column('created_at', sa.DateTime(), nullable=True))
    op.add_column('users', sa.Column('updated_at', sa.DateTime(), nullable=True))
    
    # Set default timestamps for existing users
    op.execute("UPDATE users SET created_at = NOW(), updated_at = NOW() WHERE created_at IS NULL")
    
    # Now make them non-nullable
    op.alter_column('users', 'created_at', nullable=False)
    op.alter_column('users', 'updated_at', nullable=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'updated_at')
    op.drop_column('users', 'created_at')
    op.drop_constraint(None, 'tracker_comments', type_='foreignkey')
    op.drop_constraint(None, 'tracker_comments', type_='foreignkey')
    op.create_foreign_key('tracker_comments_user_id_fkey', 'tracker_comments', 'users', ['user_id'], ['id'], ondelete='RESTRICT')
    op.create_foreign_key('tracker_comments_resolved_by_user_id_fkey', 'tracker_comments', 'users', ['resolved_by_user_id'], ['id'], ondelete='SET NULL')
    op.drop_index(op.f('ix_tracker_comments_is_resolved'), table_name='tracker_comments')
    op.drop_index(op.f('ix_tracker_comments_created_at'), table_name='tracker_comments')
    op.drop_index(op.f('ix_studies_study_label'), table_name='studies')
    op.create_index('ix_studies_study_label', 'studies', ['study_label'], unique=False)
    op.create_unique_constraint('uq_studies_study_label', 'studies', ['study_label'])
    op.drop_constraint(None, 'reporting_efforts', type_='foreignkey')
    op.drop_constraint(None, 'reporting_efforts', type_='foreignkey')
    op.create_foreign_key('reporting_efforts_study_id_fkey', 'reporting_efforts', 'studies', ['study_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key('reporting_efforts_database_release_id_fkey', 'reporting_efforts', 'database_releases', ['database_release_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_tlf_details', type_='foreignkey')
    op.create_foreign_key('reporting_effort_tlf_details_reporting_effort_item_id_fkey', 'reporting_effort_tlf_details', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key('reporting_effort_tlf_details_ich_category_id_fkey', 'reporting_effort_tlf_details', 'text_elements', ['ich_category_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('reporting_effort_tlf_details_population_flag_id_fkey', 'reporting_effort_tlf_details', 'text_elements', ['population_flag_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('reporting_effort_tlf_details_title_id_fkey', 'reporting_effort_tlf_details', 'text_elements', ['title_id'], ['id'], ondelete='SET NULL')
    op.drop_constraint(None, 'reporting_effort_items', type_='foreignkey')
    op.create_foreign_key('reporting_effort_items_reporting_effort_id_fkey', 'reporting_effort_items', 'reporting_efforts', ['reporting_effort_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'reporting_effort_item_tracker', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_item_tracker', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_item_tracker', type_='foreignkey')
    op.create_foreign_key('reporting_effort_item_tracker_reporting_effort_item_id_fkey', 'reporting_effort_item_tracker', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key('reporting_effort_item_tracker_production_programmer_id_fkey', 'reporting_effort_item_tracker', 'users', ['production_programmer_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('reporting_effort_item_tracker_qc_programmer_id_fkey', 'reporting_effort_item_tracker', 'users', ['qc_programmer_id'], ['id'], ondelete='SET NULL')
    op.drop_constraint(None, 'reporting_effort_item_footnotes', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_item_footnotes', type_='foreignkey')
    op.create_foreign_key('reporting_effort_item_footnotes_reporting_effort_item_id_fkey', 'reporting_effort_item_footnotes', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key('reporting_effort_item_footnotes_footnote_id_fkey', 'reporting_effort_item_footnotes', 'text_elements', ['footnote_id'], ['id'], ondelete='RESTRICT')
    op.drop_constraint(None, 'reporting_effort_item_acronyms', type_='foreignkey')
    op.drop_constraint(None, 'reporting_effort_item_acronyms', type_='foreignkey')
    op.create_foreign_key('reporting_effort_item_acronyms_acronym_id_fkey', 'reporting_effort_item_acronyms', 'text_elements', ['acronym_id'], ['id'], ondelete='RESTRICT')
    op.create_foreign_key('reporting_effort_item_acronyms_reporting_effort_item_id_fkey', 'reporting_effort_item_acronyms', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'reporting_effort_dataset_details', type_='foreignkey')
    op.create_foreign_key('reporting_effort_dataset_details_reporting_effort_item_id_fkey', 'reporting_effort_dataset_details', 'reporting_effort_items', ['reporting_effort_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'package_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'package_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'package_tlf_details', type_='foreignkey')
    op.drop_constraint(None, 'package_tlf_details', type_='foreignkey')
    op.create_foreign_key('package_tlf_details_population_flag_id_fkey', 'package_tlf_details', 'text_elements', ['population_flag_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('package_tlf_details_title_id_fkey', 'package_tlf_details', 'text_elements', ['title_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('package_tlf_details_ich_category_id_fkey', 'package_tlf_details', 'text_elements', ['ich_category_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key('package_tlf_details_package_item_id_fkey', 'package_tlf_details', 'package_items', ['package_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'package_items', type_='foreignkey')
    op.create_foreign_key('package_items_package_id_fkey', 'package_items', 'packages', ['package_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'package_item_footnotes', type_='foreignkey')
    op.drop_constraint(None, 'package_item_footnotes', type_='foreignkey')
    op.create_foreign_key('package_item_footnotes_footnote_id_fkey', 'package_item_footnotes', 'text_elements', ['footnote_id'], ['id'], ondelete='RESTRICT')
    op.create_foreign_key('package_item_footnotes_package_item_id_fkey', 'package_item_footnotes', 'package_items', ['package_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'package_item_acronyms', type_='foreignkey')
    op.drop_constraint(None, 'package_item_acronyms', type_='foreignkey')
    op.create_foreign_key('package_item_acronyms_acronym_id_fkey', 'package_item_acronyms', 'text_elements', ['acronym_id'], ['id'], ondelete='RESTRICT')
    op.create_foreign_key('package_item_acronyms_package_item_id_fkey', 'package_item_acronyms', 'package_items', ['package_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'package_dataset_details', type_='foreignkey')
    op.create_foreign_key('package_dataset_details_package_item_id_fkey', 'package_dataset_details', 'package_items', ['package_item_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'database_releases', type_='foreignkey')
    op.create_foreign_key('database_releases_study_id_fkey', 'database_releases', 'studies', ['study_id'], ['id'], ondelete='CASCADE')
    op.drop_constraint(None, 'audit_log', type_='foreignkey')
    op.create_foreign_key('audit_log_user_id_fkey', 'audit_log', 'users', ['user_id'], ['id'], ondelete='SET NULL')
    # ### end Alembic commands ###