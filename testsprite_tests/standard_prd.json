{
  "meta": {
    "project": "PEARL Backend",
    "date": "2025-07-30",
    "prepared_by": "Generated by Claude AI"
  },
  "product_overview": "PEARL Backend is a FastAPI-based asynchronous REST API service designed for managing research data studies, database releases, reporting efforts, text elements, and packages. It supports CRUD operations with robust referential integrity, real-time WebSocket broadcasting for live updates, and integrates tightly with a frontend R Shiny interface. The system uses PostgreSQL with async SQLAlchemy and implements comprehensive business logic including duplicate prevention, deletion protection, and detailed metadata management.",
  "core_goals": [
    "Provide a seamless and reliable backend API to manage studies, database releases, reporting efforts, text elements, and research packages.",
    "Ensure data integrity and referential constraints by preventing deletions when dependent entities exist.",
    "Enable real-time updates and collaboration by broadcasting CRUD changes through WebSocket endpoints.",
    "Implement case-insensitive duplicate detection for text elements to maintain data consistency.",
    "Support a polymorphic package item system covering TLFs and Datasets with detailed metadata and associations.",
    "Maintain a clean architecture separating API, CRUD, model, and schema layers for maintainability and testing.",
    "Facilitate easy integration with frontend R Shiny modules with pre-configured CORS and data validation."
  ],
  "key_features": [
    "CRUD APIs for managing Studies, ensuring unique labels and prevention of study deletion if dependent database releases exist.",
    "Database Releases API scoped to Studies with deletion protection if reporting efforts exist, and unique label enforcement per study.",
    "Reporting Efforts CRUD linked to Studies and Database Releases with standard create, read, update, and delete operations.",
    "Unified Text Elements system with four enum-based categories (title, footnote, population_set, acronyms_set), supporting full CRUD, case-insensitive duplicate prevention, and full-text search capabilities.",
    "Comprehensive Packages subsystem managing polymorphic items (TLF, Dataset) with detailed metadata, many-to-many footnotes and acronyms associations, and deletion protection to maintain referential integrity.",
    "Real-time WebSocket broadcasting for all entities (Studies, Database Releases, Reporting Efforts, Text Elements, Packages) providing live updates to connected clients.",
    "Health API endpoint for service liveness and database connectivity checks.",
    "Strict deletion protection patterns with descriptive user errors guiding dependent entity management before deletion.",
    "Robust data validation via Pydantic schemas and timestamped audit trails for created and updated records."
  ],
  "user_flow_summary": [
    "Users create new Studies with unique labels to organize research studies.",
    "Within a Study, users can create Database Releases, ensuring no duplicate release labels within the same study.",
    "For each Database Release, users manage Reporting Efforts contributing data to ongoing research.",
    "Users manage Text Elements categorized as titles, footnotes, population sets, or acronym sets, using search to find existing elements and prevented from creating duplicates based on normalized content.",
    "Users create Packages that group research outputs, adding polymorphic items such as TLFs or Datasets, each with detailed metadata and associations to Text Elements for footnotes and acronyms.",
    "Real-time changes to any entity reflect immediately to all connected clients through WebSocket broadcasting, enabling collaborative workflows.",
    "Deletion operations check for dependent entities and prevent removal if dependents exist, informing users to delete dependencies first.",
    "Health checks ensure the backend service and database connections are operational, supporting monitoring and alerting."
  ],
  "validation_criteria": [
    "All CRUD operations must pass through the CRUD layer classes adhering to domain rules.",
    "Deletions are blocked when dependent entities exist, with appropriate HTTP 400 responses and descriptive error messages listing dependencies.",
    "WebSocket broadcasts serialize data correctly with enums and datetime fields, enabling live client updates without errors.",
    "Duplicate text elements are detected case-insensitively by normalizing labels (removing spaces and uppercasing) and prevented from creation or update.",
    "Data schemas enforce input validation with Pydantic, ensuring enum types and required fields are validated at API boundaries.",
    "Health API returns HTTP 200 with service status and 503 when database connectivity is lost.",
    "Referential integrity enforced by proper foreign keys and CRUD methods like get_by_study_id and get_by_database_release_id.",
    "Extensive individual tests use HTTP-level testing to avoid SQLAlchemy async session conflicts, guaranteeing stable CRUD functionality.",
    "WebSocket endpoint implements connection management with cleanup of stale connections and manual database session management.",
    "Package item uniqueness enforced by composite keys and validated on creation and updates.",
    "Audit trails record created_at and updated_at timestamps consistently for all entities."
  ],
  "code_summary": {
    "tech_stack": [
      "Python 3.11",
      "FastAPI",
      "SQLAlchemy 2 (async) + asyncpg",
      "Pydantic v2",
      "Alembic",
      "PostgreSQL",
      "WebSocket (FastAPI)",
      "Uvicorn",
      "UV (package manager)",
      "R Shiny (admin-frontend)",
      "bslib",
      "shinyvalidate"
    ],
    "features": [
      {
        "name": "Health API",
        "description": "Service liveness and database connectivity check.",
        "files": [
          "backend/app/api/health.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Health API",
            "version": "1.0.0"
          },
          "paths": {
            "/health": {
              "get": {
                "summary": "Health check with DB connectivity",
                "responses": {
                  "200": {
                    "description": "Service healthy"
                  },
                  "503": {
                    "description": "Service unhealthy"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Studies API",
        "description": "CRUD for studies with real-time WebSocket broadcasting.",
        "files": [
          "backend/app/api/v1/studies.py",
          "backend/app/schemas/study.py",
          "backend/app/crud/study.py",
          "backend/app/models/study.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Studies API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/studies": {
              "get": {
                "summary": "List studies",
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create study",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate label"
                  }
                }
              }
            },
            "/api/v1/studies/{study_id}": {
              "get": {
                "summary": "Get study by id",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update study",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate label"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete study (blocked if releases exist)",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent releases"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Database Releases API",
        "description": "CRUD for database releases, scoped to a study, with deletion protection when reporting efforts exist.",
        "files": [
          "backend/app/api/v1/database_releases.py",
          "backend/app/schemas/database_release.py",
          "backend/app/crud/database_release.py",
          "backend/app/models/database_release.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Database Releases API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/database-releases": {
              "get": {
                "summary": "List releases (optional study_id)",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "query",
                    "required": false,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create release",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate label for study"
                  },
                  "404": {
                    "description": "Study not found"
                  }
                }
              }
            },
            "/api/v1/database-releases/{database_release_id}": {
              "get": {
                "summary": "Get release by id",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update release",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate label for study"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete release (blocked if reporting efforts exist)",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent reporting efforts"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Reporting Efforts API",
        "description": "CRUD for reporting efforts linked to a study and database release.",
        "files": [
          "backend/app/api/v1/reporting_efforts.py",
          "backend/app/schemas/reporting_effort.py",
          "backend/app/crud/reporting_effort.py",
          "backend/app/models/reporting_effort.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Reporting Efforts API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/reporting-efforts": {
              "get": {
                "summary": "List reporting efforts",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "database_release_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create reporting effort",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Foreign key mismatch"
                  },
                  "404": {
                    "description": "Study or release not found"
                  }
                }
              }
            },
            "/api/v1/reporting-efforts/{reporting_effort_id}": {
              "get": {
                "summary": "Get reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Text Elements API",
        "description": "CRUD and search for unified text elements with enum types (title, footnote, population_set, acronyms_set). Includes duplicate-prevention logic.",
        "files": [
          "backend/app/api/v1/text_elements.py",
          "backend/app/schemas/text_element.py",
          "backend/app/crud/text_element.py",
          "backend/app/models/text_element.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Text Elements API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/text-elements": {
              "get": {
                "summary": "List text elements",
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "type",
                    "in": "query",
                    "schema": {
                      "type": "string",
                      "enum": [
                        "title",
                        "footnote",
                        "population_set",
                        "acronyms_set"
                      ]
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create text element (duplicate-protected)",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate"
                  }
                }
              }
            },
            "/api/v1/text-elements/search": {
              "get": {
                "summary": "Search text elements by label",
                "parameters": [
                  {
                    "name": "q",
                    "in": "query",
                    "required": true,
                    "schema": {
                      "type": "string"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              }
            },
            "/api/v1/text-elements/{text_element_id}": {
              "get": {
                "summary": "Get text element",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update text element (duplicate-protected)",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete text element",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Packages API",
        "description": "CRUD for packages and polymorphic package items (TLF, Dataset) with detailed metadata, associations and WebSocket events.",
        "files": [
          "backend/app/api/v1/packages.py",
          "backend/app/schemas/package.py",
          "backend/app/schemas/package_item.py",
          "backend/app/crud/package.py",
          "backend/app/crud/package_item.py",
          "backend/app/models/package.py",
          "backend/app/models/package_item.py",
          "backend/app/models/package_tlf_details.py",
          "backend/app/models/package_dataset_details.py",
          "backend/app/models/package_item_footnote.py",
          "backend/app/models/package_item_acronym.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Packages API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/packages": {
              "get": {
                "summary": "List packages",
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create package (unique name)",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate name"
                  }
                }
              }
            },
            "/api/v1/packages/{package_id}": {
              "get": {
                "summary": "Get package with items",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update package (unique name)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate name"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete package (blocked if items exist)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent items"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            },
            "/api/v1/packages/{package_id}/items": {
              "get": {
                "summary": "List items for a package",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create item with details (unique by composite key)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate composite key or missing refs"
                  },
                  "404": {
                    "description": "Package or Study not found"
                  }
                }
              }
            },
            "/api/v1/packages/items/{item_id}": {
              "get": {
                "summary": "Get specific item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "WebSocket",
        "description": "Real-time updates broadcasting for studies, database releases, reporting efforts, text elements, and packages. Endpoint provides initial snapshot and accepts refresh/ping actions.",
        "files": [
          "backend/app/api/v1/websocket.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "WebSocket Endpoint",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/ws/studies": {
              "get": {
                "summary": "WebSocket upgrade to subscribe to real-time study updates",
                "responses": {
                  "101": {
                    "description": "Switching Protocols"
                  }
                }
              }
            }
          }
        }
      }
    ]
  }
}
