{
  "meta": {
    "project": "PEARL Research Data Management System",
    "date": "2025-07-30",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "PEARL is a unified full-stack research data management system designed to provide a reliable backend with real-time WebSocket updates and a modern admin frontend for managing studies, database releases, reporting efforts, text elements, and packages. It ensures data integrity, supports complex CRUD operations, and synchronizes multi-user sessions via real-time events.",
  "core_goals": [
    "Provide comprehensive CRUD APIs for core research data entities including Studies, Database Releases, Reporting Efforts, Text Elements, Packages, and Package Items.",
    "Guarantee strong data integrity through duplicate prevention and deletion protection mechanisms.",
    "Offer real-time synchronization of data changes via WebSocket broadcasting to support live multi-user collaboration.",
    "Ensure clear, documented API contracts with OpenAPI specs and health monitoring endpoints for operational reliability.",
    "Deliver a responsive, robust, and user-friendly admin frontend with real-time updates and validation feedback."
  ],
  "key_features": [
    "Health API endpoint to check service liveness and database connectivity.",
    "Manage Studies with unique labels, including create, read, update, delete operations and real-time WebSocket events.",
    "CRUD operations for Database Releases scoped to a Study, enforcing uniqueness and deletion protection when reporting efforts exist.",
    "Reporting Efforts CRUD linked to Studies and Database Releases with real-time event broadcasting.",
    "Unified Text Elements management (titles, footnotes, population sets, acronyms sets) with duplicate prevention and search functionality.",
    "Comprehensive Packages system managing polymorphic package items (TLFs and Datasets) with detailed metadata, associations, and real-time WebSocket updates.",
    "Real-time WebSocket endpoint for broadcasting CRUD events and initial snapshot data, supporting client actions like refresh and ping.",
    "Robust frontend UI built with R Shiny using bslib and shinyvalidate, enabling responsive, real-time synchronized data management.",
    "Validation and error handling on both backend and frontend layers, providing clear feedback for duplicate prevention, referential integrity, and data constraints."
  ],
  "user_flow_summary": [
    "User launches the admin frontend; WebSocket connection to backend is established to receive initial data snapshot and real-time updates.",
    "Admin Data Manager creates a new Study via the frontend form; backend validates uniqueness and broadcasts a study_created event.",
    "User selects a Study and manages associated Database Releases, ensuring no duplicate labels; releases are broadcast for UI synchronization.",
    "Within a selected Study and Release, Reporting Efforts are managed, created, updated, or deleted with validation of linked entities and real-time events.",
    "Text Elements across four types are created or edited via a unified interface with duplicate checks and searchable lists with live updates.",
    "Users navigate to the Packages Registry to create new packages with a unique name and add polymorphic items with detailed subtype-specific metadata.",
    "Package and Package Item CRUD operations broadcast real-time WebSocket events so all connected sessions remain in sync.",
    "Deletion operations are protected to prevent removal of entities with dependent children, with detailed error messages guiding corrective actions.",
    "Frontend UI provides responsive data tables with pagination, filtering, modal dialogs, slide-in forms, and clear action buttons aligned to backend API.",
    "WebSocket events received by the frontend update UI components dynamically, reflecting changes from other users or sessions instantly."
  ],
  "validation_criteria": [
    "All CRUD endpoints return appropriate HTTP status codes (e.g., 200, 201, 400, 404, 422) and enforce business rules reliably.",
    "Duplicate labels/names detection blocks resource creation or update with informative HTTP 400 error messages.",
    "Deletion protection actively prevents removal of entities that have dependent records, providing descriptive errors with dependent entity names.",
    "WebSocket broadcasts occur instantly after CRUD operations, delivering event notifications and updated entity data to all active connections.",
    "WebSocket connection lifecycle management supports client refresh and ping actions, and removes stale/disconnected clients properly.",
    "Frontend forms validate inputs immediately via shinyvalidate, enforcing constraints before submission.",
    "Tests demonstrate reliable multi-session synchronization of data changes via WebSocket events.",
    "The Health API consistently returns service and database connectivity status with HTTP 200/503 as appropriate.",
    "API documentation is up-to-date and available via /docs and /redoc endpoints.",
    "Performance supports pagination and efficient data loading with no UI blocking or server delays.",
    "Model validation tools run successfully verifying Pydantic and SQLAlchemy schema alignment after any model changes.",
    "Error handling captures and logs all failures with structured messages, both in API responses and WebSocket events.",
    "UI displays clear connection status indicators (Connected, Disconnected, Reconnecting) and shows validation or error notifications distinctly.",
    "All real-time updates properly serialize enum types and datetime values to JSON without errors.",
    "Admin frontend's package management modules allow creation, editing (where implemented), deletion, and listing with unique constraints enforced and error feedback managed."
  ],
  "code_summary": {
    "tech_stack": [
      "Python 3.11",
      "FastAPI",
      "SQLAlchemy 2 (async) + asyncpg",
      "Pydantic v2",
      "Alembic",
      "PostgreSQL",
      "WebSocket (FastAPI)",
      "Uvicorn",
      "UV (package manager)",
      "R Shiny (admin-frontend)",
      "bslib",
      "shinyvalidate"
    ],
    "features": [
      {
        "name": "Health API",
        "description": "Service liveness and database connectivity check.",
        "files": [
          "backend/app/api/health.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Health API",
            "version": "1.0.0"
          },
          "paths": {
            "/health": {
              "get": {
                "summary": "Health check with DB connectivity",
                "responses": {
                  "200": {
                    "description": "Service healthy"
                  },
                  "503": {
                    "description": "Service unhealthy"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Studies API",
        "description": "CRUD for studies with real-time WebSocket broadcasting.",
        "files": [
          "backend/app/api/v1/studies.py",
          "backend/app/schemas/study.py",
          "backend/app/crud/study.py",
          "backend/app/models/study.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Studies API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/studies": {
              "get": {
                "summary": "List studies",
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create study",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate label"
                  }
                }
              }
            },
            "/api/v1/studies/{study_id}": {
              "get": {
                "summary": "Get study by id",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update study",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate label"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete study (blocked if releases exist)",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent releases"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Database Releases API",
        "description": "CRUD for database releases, scoped to a study, with deletion protection when reporting efforts exist.",
        "files": [
          "backend/app/api/v1/database_releases.py",
          "backend/app/schemas/database_release.py",
          "backend/app/crud/database_release.py",
          "backend/app/models/database_release.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Database Releases API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/database-releases": {
              "get": {
                "summary": "List releases (optional study_id)",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "query",
                    "required": false,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create release",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate label for study"
                  },
                  "404": {
                    "description": "Study not found"
                  }
                }
              }
            },
            "/api/v1/database-releases/{database_release_id}": {
              "get": {
                "summary": "Get release by id",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update release",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate label for study"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete release (blocked if reporting efforts exist)",
                "parameters": [
                  {
                    "name": "database_release_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent reporting efforts"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Reporting Efforts API",
        "description": "CRUD for reporting efforts linked to a study and database release.",
        "files": [
          "backend/app/api/v1/reporting_efforts.py",
          "backend/app/schemas/reporting_effort.py",
          "backend/app/crud/reporting_effort.py",
          "backend/app/models/reporting_effort.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Reporting Efforts API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/reporting-efforts": {
              "get": {
                "summary": "List reporting efforts",
                "parameters": [
                  {
                    "name": "study_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "database_release_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create reporting effort",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Foreign key mismatch"
                  },
                  "404": {
                    "description": "Study or release not found"
                  }
                }
              }
            },
            "/api/v1/reporting-efforts/{reporting_effort_id}": {
              "get": {
                "summary": "Get reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete reporting effort",
                "parameters": [
                  {
                    "name": "reporting_effort_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Text Elements API",
        "description": "CRUD and search for unified text elements with enum types (title, footnote, population_set, acronyms_set). Includes duplicate-prevention logic.",
        "files": [
          "backend/app/api/v1/text_elements.py",
          "backend/app/schemas/text_element.py",
          "backend/app/crud/text_element.py",
          "backend/app/models/text_element.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Text Elements API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/text-elements": {
              "get": {
                "summary": "List text elements",
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "type",
                    "in": "query",
                    "schema": {
                      "type": "string",
                      "enum": [
                        "title",
                        "footnote",
                        "population_set",
                        "acronyms_set"
                      ]
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create text element (duplicate-protected)",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate"
                  }
                }
              }
            },
            "/api/v1/text-elements/search": {
              "get": {
                "summary": "Search text elements by label",
                "parameters": [
                  {
                    "name": "q",
                    "in": "query",
                    "required": true,
                    "schema": {
                      "type": "string"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              }
            },
            "/api/v1/text-elements/{text_element_id}": {
              "get": {
                "summary": "Get text element",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update text element (duplicate-protected)",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete text element",
                "parameters": [
                  {
                    "name": "text_element_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Packages API",
        "description": "CRUD for packages and polymorphic package items (TLF, Dataset) with detailed metadata, associations and WebSocket events.",
        "files": [
          "backend/app/api/v1/packages.py",
          "backend/app/schemas/package.py",
          "backend/app/schemas/package_item.py",
          "backend/app/crud/package.py",
          "backend/app/crud/package_item.py",
          "backend/app/models/package.py",
          "backend/app/models/package_item.py",
          "backend/app/models/package_tlf_details.py",
          "backend/app/models/package_dataset_details.py",
          "backend/app/models/package_item_footnote.py",
          "backend/app/models/package_item_acronym.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "Packages API",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/packages": {
              "get": {
                "summary": "List packages",
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create package (unique name)",
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate name"
                  }
                }
              }
            },
            "/api/v1/packages/{package_id}": {
              "get": {
                "summary": "Get package with items",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update package (unique name)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "400": {
                    "description": "Duplicate name"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete package (blocked if items exist)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "400": {
                    "description": "Has dependent items"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            },
            "/api/v1/packages/{package_id}/items": {
              "get": {
                "summary": "List items for a package",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  }
                }
              },
              "post": {
                "summary": "Create item with details (unique by composite key)",
                "parameters": [
                  {
                    "name": "package_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Created"
                  },
                  "400": {
                    "description": "Duplicate composite key or missing refs"
                  },
                  "404": {
                    "description": "Package or Study not found"
                  }
                }
              }
            },
            "/api/v1/packages/items/{item_id}": {
              "get": {
                "summary": "Get specific item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "OK"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "put": {
                "summary": "Update item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Updated"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete item",
                "parameters": [
                  {
                    "name": "item_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Deleted"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "WebSocket",
        "description": "Real-time updates broadcasting for studies, database releases, reporting efforts, text elements, and packages. Endpoint provides initial snapshot and accepts refresh/ping actions.",
        "files": [
          "backend/app/api/v1/websocket.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "info": {
            "title": "WebSocket Endpoint",
            "version": "1.0.0"
          },
          "paths": {
            "/api/v1/ws/studies": {
              "get": {
                "summary": "WebSocket upgrade to subscribe to real-time study updates",
                "responses": {
                  "101": {
                    "description": "Switching Protocols"
                  }
                }
              }
            }
          }
        }
      }
    ]
  }
}
